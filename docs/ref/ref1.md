## HTTPS-Miner/perplexity-ai 開発補助資料

この資料は、GitHubリポジトリ `HTTPS-Miner/perplexity-ai` の理解、カスタマイズ、拡張を支援することを目的とした開発者向けの技術情報を提供します。README[1]に基づき、具体的な実装概要や開発のポイントを解説します。

### 1. プロジェクト概要と目的

*   **目的:** Perplexity AI (perplexity.ai) とのWebブラウザ上の対話を自動化する[1]。
*   **主な機能:**
    *   テキストファイル (`prompt.txt`) から入力を読み込む[1]。
    *   SeleniumとFirefoxを使用してperplexity.ai上でテキストを送信する[1]。
    *   AIからの応答を取得する[1]。
    *   取得した応答をMarkdown形式 (`output.md`) で保存する[1]。
*   **利点:** 手動でのブラウザ操作なしに、効率的にPerplexity AIとの対話を実行できる[1]。

### 2. 技術スタック

開発や実行には以下の技術・ライブラリが必要です。

*   **プログラミング言語:** Python (3.11.2でテスト済み)[1]
*   **主要ライブラリ:**
    *   `selenium`: Webブラウザの自動操作[1]。
    *   `beautifulsoup4`: HTMLコンテンツの解析[1]。
    *   `markdownify`: HTMLからMarkdownへの変換[1]。
*   **ブラウザ:** Firefox (パス指定が必要な場合あり)[1]
*   **プラットフォーム:** Linux, Windows (クロスプラットフォーム対応)[1]

### 3. プロジェクト構造 (推定)

README[1]から以下の基本的なファイル構成が推測されます。リポジトリをクローンして詳細を確認してください。

```
perplexity-ai/
├── main.py             # メインの実行スクリプト
├── prompt.txt          # AIへの入力テキストファイル (ユーザー作成)
├── response_to_markdown/
│   └── output.md       # AIからの応答を保存するMarkdownファイル (スクリプト生成)
└── requirements.txt    # (存在する場合) 依存ライブラリリスト
└── .gitignore          # (存在する場合) Git管理対象外ファイル指定
└── README.md           # プロジェクトの説明ファイル
└── (myenv/)            # (ユーザー作成) Python仮想環境
```

### 4. 主要機能の実装概要 (推定含む)

`main.py` 内で以下のような処理が行われていると推測されます。

*   **初期設定:**
    *   Selenium WebDriver (Firefox) の初期化[1]。
    *   Firefoxのバイナリパス設定 (Windowsの場合、ユーザーによる編集が必要)[1]。
    *   ヘッドレスモードの設定 (オプション、コメントアウトで切り替え)[1]。
*   **入力処理:**
    *   `prompt.txt` ファイルを開き、内容を読み込む[1]。
*   **Perplexity AI サイト操作 (Selenium):**
    *   `perplexity.ai` を開く。
    *   入力フィールドのHTML要素を特定 (例: `id`や`name`属性、CSSセレクタ、XPathを使用)。
    *   `prompt.txt` の内容を入力フィールドに送信する。
    *   送信ボタンをクリックする。
    *   応答が表示されるまで待機する (Explicit Waitsなどを使用)。
    *   応答が含まれるHTML要素を特定する。
*   **応答データ抽出 (BeautifulSoup4):**
    *   応答要素のHTMLコンテンツを取得する。
    *   BeautifulSoup4を使ってHTMLを解析し、必要なテキストや構造を抽出する[1]。
*   **出力処理 (Markdownify):**
    *   抽出したHTML応答を`markdownify`を使ってMarkdown形式に変換する[1]。
    *   変換後のMarkdownテキストを `response_to_markdown/output.md` ファイルに書き込む[1]。
*   **終了処理:**
    *   WebDriverを終了する。

### 5. カスタマイズと拡張のポイント

このツールを改修・拡張する際のヒントです。

*   **UI変更への対応:**
    *   Perplexity AIのWebサイトのHTML構造が変更されると、要素特定（セレクタ）が失敗する可能性があります。定期的にセレクタを確認し、`main.py`内の要素特定部分を修正する必要があります。ブラウザの開発者ツールが役立ちます。
*   **エラーハンドリング:**
    *   要素が見つからない、タイムアウト、ネットワークエラーなど、起こりうるエラーに対する `try-except` ブロックを追加して、スクリプトの堅牢性を高めることを検討してください。
*   **対応ブラウザの追加:**
    *   Chromeなど他のブラウザに対応させるには、該当するWebDriver（例: ChromeDriver）をインストールし、`main.py`のWebDriver初期化部分を変更する必要があります。
*   **入出力形式の変更:**
    *   入力ファイルをJSON形式にしたり、複数のプロンプトを扱えるように変更する。
    *   出力をJSON、CSV、プレーンテキストなど他の形式で保存するように変更する。
*   **Perplexity AI機能の活用:**
    *   Focusモード（Academic, YouTubeなど）[5]やCopilotモード[5]を利用するには、対応するUI要素（ボタンなど）を特定し、Seleniumで操作するコードを追加する必要があります。
*   **設定の外部化:**
    *   ファイルパス、待機時間、セレクタなどを設定ファイル (`config.ini`, `.env`など) に分離すると、コードを変更せずに設定を調整でき、保守性が向上します。
*   **ロギング:**
    *   `logging` モジュールを導入して、処理の進行状況やエラー情報をファイルに出力すると、デバッグや運用監視が容易になります。

### 6. デバッグのヒント

*   **ヘッドレスモードの無効化:** デバッグ中は `main.py` の該当行をコメントアウトし、ブラウザの動作を目で見て確認するのが最も効果的です[1]。
*   **`print`文/`logging`:** 変数の内容や処理の通過点を `print` 文や `logging` で出力して確認します。
*   **待機時間:** 要素が表示される前にアクセスしようとしてエラーになる場合が多いです。Seleniumの `WebDriverWait` と `expected_conditions` を使った適切な待機処理（Explicit Waits）を追加・調整します。
*   **要素セレクタの確認:** ブラウザの開発者ツール（要素の検証/Inspect）を使って、指定しているセレクタ（CSSセレクタやXPath）が正しいか、対象要素を一意に特定できているかを確認します。